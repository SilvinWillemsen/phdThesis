\chapter{The Trombone}\label{ch:trombone}
This chapter provides an extended summary for the paper ``A Physical Model of the Trombone using Dynamic Grids for Finite-Difference Schemes'' \citeP[H]. 

The trombone is an extremely interesting instrument from a simulation perspective due to the time-varying length of the acoustic tube. In FDTD-based simulations the trombone poses a challenge due to issues regarding adding and removing points to the grid, or simulation quality, as also pointed out by Harrison in \cite{Harrison2018}. As the dynamic grid method presented in paper \citeP[G] (also see Chapter \ref{ch:dynamicGrid}) attempts to resolve these issues, the trombone is an excellent use case for this method to be applied to. 

The air propagation in the trombone has been modelled using a system of two first-order PDEs, presented in Section \ref{sec:firstOrderSystem}. Although Webster's equation presented in Section \ref{sec:webstersEq}) could have been used, the state-of-the-art models for brass instruments using FDTD methods use first-order PDEs \cite{Bilbao2016, Harrison2018}. Some extensions, such as the Levine and Schwinger radiation model presented in \ref{sec:levineSchwing} and used in \cite{Harrison2018} and viscothermal losses in \cite{Bilbao2016}, could then easily be added, although the latter has been left for future work.

This chapter first presents a short summary of paper \citeP[H] that relates its contents to the rest of this thesis. Then, as the process of applying the dynamic grid method to the trombone is not straightforward, several considerations made during this process will be given. Finally, the collision method from Chapter \ref{ch:collisions} is applied to the lip reed presented in Chapter \ref{ch:lipreed},
and details on the implementation will be given. 

% with the idea that viscothermal losses could be added as done in \cite{Bilbao2016} where the authors also use a first-order system
% Interesting read: https://newt.phys.unsw.edu.au/jw/brassacoustics.html

\section{Summary}
The paper presents a real-time implementation of the trombone based on FDTD methods and using the dynamic grid method presented in Chapter \ref{ch:dynamicGrid}. The acoustic tube has been modelled using a system of first-order equations as described in Section \ref{sec:firstOrderSystem}, and the lip reed has been modelled using the 1-DoF mass spring system presented in Chapter \ref{ch:lipreed}. The lip reed has been extended using the collision method described in Chapter \ref{ch:collisions}, details of which will be given in Section \ref{sec:lipReedWithCollision}. 

An application was made implementing the trombone in real time in C++ using the JUCE framework (see Chapter \ref{ch:realtime}). The application and can be found online, as well as a demo showcasing it.\footnote{\url{https://github.com/SilvinWillemsen/cppBrass/releases/}}\textsuperscript{,}\footnote{\url{https://youtu.be/Ht5gVNrshYo}} The implementation allowed for the total range of the tube length ($2.593$-$3.653$ m) to be traversed in $0.06$ s (corresponding to 20 samples between grid configurations). An informal evaluation by the authors showed that no noticeable artefacts were observed. Naturally, proper listening tests need to confirm this. It must be noted that to ensure stability, especially at fast changes between grid configurations, the Courant number has been set slightly lower than the stability condition ($\lambda = 0.999$). This decrease in $\lambda$ does cause a small, but negligible decrease in simulation quality and bandwidth (see Section \ref{sec:quality1DWave}). 

Future work includes to add viscothermal losses \cite{Bilbao2016} and nonlinear effects \cite{msallam1997physical}, as well as investigating intuitive mapping to control the simulation.

% As the paper mentions, the state of the particle velocity of the right system exhibits a `drift', but does not affect the output of the system. Future work

\section{Dynamic grid considerations}
The main contribution of the paper is the use of the dynamic grid method to implement the time-varying acoustic tube. As paper \citeP[H] provides extensive details on the implementation of the dynamic grid method applied to the case of the trombone, these will not be given here. Instead, this section presents several considerations that needed to be taken into account in order to use the dynamic grid method in the case of the acoustic tube. 

\subsubsection{First-order system}
The dynamic grid method presented in paper \citeP[G] uses the 1D wave equation as a test case. Although this is not used to model the trombone, the underlying behaviour is the same for a cylindrical tube. Section \ref{sec:firstOrderSystemCont} shows that the first-order system in Eq. \eqref{eq:firstOrderSystem} can be reduced to Webster's equation, which -- for a cylindrical tube -- reduces to the 1D wave equation. It was therefore concluded, that the dynamic grid method could be applied to the acoustic tube, under the condition that its cross-section does not vary at the location where the method is applied. In other words, as long as the system was split at a location of constant cross-section %grid points used in calculation of the virtual grid points at the inner boundaries in Eq. \eqref{eq:connectionInterpol} have the same value for the cross-sectional area 
the method should continue to work. 

As the first-order system modelling the trombone consists of two state variables, a decision needed to be made about on what grid to apply the dynamic grid method. In other words, what state variable -- the pressure or the particle velocity -- should be used to calculate the virtual grid points at the inner boundaries. As the state of the pressure variable in Eq. \eqref{eq:contPressure} is discretised to the non-interleaved grid, it was chosen to apply the dynamic grid method to the pressure grid rather than that of the particle velocity. That said, if the constraint on the constant cross-section is kept, applying the method to the velocity grid should work just as well.

\subsubsection{Location of split}
It was chosen to split the system in the middle of the slide crook of the trombone, i.e., at the far end of the trombone slide. First of all, it could be reasonable to assume that the air in the tube to ``go away from'' or ``go towards'' that point as the slide extends or contracts. Secondly, the cross-sectional area is constant at this location satisfies the aforementioned condition.

\subsubsection{Time-varying length}
In paper \citeP[G], the time-varying parameter is the wave speed $c$, whereas the trombone has a time-varying length $L$. As stated in paper \citeP[G], $c$ and $L$ are linked by the fundamental frequency in Eq. \eqref{eq:fundamentalFreq} and a change in one yields identical behaviour as an inverse change in the other. Therefore, the method could easily be applied to a system with a time-varying length rather than a time-varying wave speed. Naturally, in an acoustic tube with a variable cross-section, a change in $c$ would definitely be different than a change in $L$, which is also why a varying wave speed was not used.

% \subsubsection{Design considerations}
% As the geometry varies it matters a lot where points are added and removed as this might influence the way that the method is implemented. 

% To combat the drift, experiments have been done involving different ways of connecting the left and right tube. One involved alternating between applying the connection to the pressures and the velocity. Here, rather than adding points to the left and right system in alternating fashion, points were added to pressures $p$ and $q$ and velocities $v$ and $w$ in an alternating fashion. Another experiment involved a ``staggered'' version of the connection where (fx.) for one system (either left or right), a virtual grid point of the velocity was created from known values according to \eqref{eq:connectionInterpol}, rather than both from pressures. This, however, showed unstable behaviour. No concluding statements can be made about these experiments at this point. \SWcomment[$\leftarrow$ which is exactly why I don't want to include this section]

\section{Lip-reed with collision}\label{sec:lipReedWithCollision}
\def\nph{}
\def\nphSys{n+1/2}
To excite the trombone, the lip reed model presented in Chapter \ref{ch:lipreed} was used, and extended using the collision method presented in Chapter \ref{ch:collisions}. This section provides details on this combination and the implementation and follows the notation of the thesis for consistency.

\subsection{Continuous time}
In continuous time, a collision can be added to Eq. \eqref{eq:lipReedDimensional} in the same way as for the mass-barrier collision presented in Section \ref{sec:massRigidBarrier} as
\begin{equation}\label{eq:lipWithCollisionCont}
    M\ddot y = -K y - R \dot y + S_\text{r}\Delta p + \psi g
\end{equation}
where $g = \psi'$ and $\psi$ and $\psi'$ are as defined in Eq. \eqref{eq:quadraticPotential}.\footnote{Notice that as $y$ is the displacement of the upper lip, the `barrier' modelling the lower lip is placed below, resulting in a positive collision force on $y$.} In the implementation, the frequency of the lip reed is made to be time varying and causes $K = K(t)$ to be time-dependent. Other parameters are the same as in Eq. \eqref{eq:lipReedDimensional}.

\subsection{Discrete time}
The discretisation follows Section \ref{sec:massRigidBarrier} for the collision and Section \ref{sec:discreteLipReed} for the lip reed.

As the lip reed is discretised on the interleaved (temporal) grid, the collision term needs to be as well. Dividing all terms by $M$ and using $\omega_0 = \omega_0^{n+1/2} = \sqrt{K^{n+1/2}/M}$ and $\sigma_\rtxt = R/M$ yields\footnote{Note that the paper uses $\omega_r$ and $M_r$ instead of $\omega_0$ and $M$.}
\begin{equation}\label{eq:preLipCollision}
    \delta_{tt}y^{\nphSys} = -\omega_0^2\mu_{t\cdot}y^{\nphSys}-\sigma_\text{r}\delta_{t\cdot}y^{\nphSys} + \frac{S_\text{r}}{M}\Delta p^{\nphSys} + \frac{\psi^{n+1/2}g^{n+1/2}}{M}.
\end{equation}
Here,
\begin{equation}\label{eq:gnph}
    g^{n+1/2} = \frac{\delta_{t+}\psi^n}{\delta_{t\cdot}\eta^{n+1/2}}\ ,
\end{equation}
and the distance between the lips
\begin{equation}\label{eq:etaBarrier}
    \eta^{n+1/2} = -H_0 - y^{n+1/2}
\end{equation}
with static equilibrium separation $H_0$. Here $-H_0$ can be interpreted as the location of the lower lip.
% \begin{equation}
%     M\delta_{tt}y^{\nph} = -M\omega_0^2\mu_{t\cdot}y^{\nph}-M\sigma_\text{r}\delta_{t\cdot}y^{\nph} + S_\text{r}\Delta p^{\nph} + \psi^{n+1/2}(\psi^{n+1/2})', 
% \end{equation}
Using $\mu_{t+}\psi^n = \psi^{n+1/2}$ (which is Eq. \eqref{eq:psiHalfDef} shifted to the interleaved grid), Eq. \eqref{eq:preLipCollision} can be rewritten to
\begin{equation*}
    \delta_{tt}y^{\nphSys} = -\omega_0^2\mu_{t\cdot}y^{\nphSys}-\sigma_\text{r}\delta_{t\cdot}y^{\nphSys} + \frac{S_\text{r}}{M}\Delta p^{\nphSys} + \frac{(\mtp\psi^n)g^{n+1/2}}{M}.
\end{equation*}
In the following, the superscript $n+1/2$ is suppressed for $y$, $\Delta p$, $g$ and $\eta$ for brevity. Rewriting Eq. \eqref{eq:gnph} to
\begin{equation}\label{eq:rewrittenPsi}
    \delta_{t+}\psi^n = g\delta_{t\cdot}\eta
\end{equation}
and using identity \eqref{eq:identity3}, one arrives at
\begin{equation}\label{eq:lipReedFDSCollision}
    \delta_{tt}y^{\nph} = -\omega_0^2\mu_{t\cdot}y^{\nph}-\sigma_\text{r}\delta_{t\cdot}y^{\nph} + \frac{S_\text{r}}{M}\Delta p^{\nph} + \left(\frac{k}{2}g\delta_{t\cdot}\eta + \psi^n\right)\frac{g}{M}
\end{equation}
As the barrier is static and placed below $y$, this implies that
\begin{equation}\label{eq:etaNegY} 
    \delta_{t\cdot}\eta = -\delta_{t\cdot}y,
\end{equation}
and a solution for $y^{n+3/2}$ can be obtained:
% \begin{align}
%     \frac{1}{k^2}(y^{n+3/2} - 2y^{n+1/2} + y^{n-1/2}) = &-\frac{\omega_0^2}{2}(y^{n+3/2}+y^{n-1/2})-\frac{\sigma_\text{r}}{2k}(y^{n+3/2}-y^{n-1/2})\nonumber \\
%     &+ \frac{S_\text{r}}{M}\Delta p^{\nph}  -\frac{g^2}{4M}(y^{n+3/2}-y^{n-1/2}) + \frac{g}{M}\psi^n\nonumber\\
%     \left(2 + \omega_0^2 k^2 + \sigma_\text{r} k + \frac{g^2k^2}{2M}\right) y^{n+3/2} &= 4y^{n+1/2}+ \left(\sigma_\text{r}k - 2 - \omega_0^2k^2 + \frac{g^2k^2}{2M}\right) y^{n-1/2}\nonumber\\
%     &+ \frac{2S_\text{r}k^2}{M}\Delta p^{\nph} + \frac{2gk^2}{M}\psi^n\nonumber.
% \end{align}
% This can be compactly written as
\begin{equation}\label{eq:lipUpdateWithCollision}
    \alpha_\text{r}y^{n+3/2} = 4 y^{n+1/2} + \beta_\text{r}y^{n-1/2} + \xi_\text{r}\Delta p + 4\psi^n\gamma_\text{r}
\end{equation}
with
\begin{gather}
    \alpha_\text{r} = 2 + \omega_0^2 k^2 + \sigma_\text{r} k + g\gamma_\text{r}, \quad \beta_\text{r} = \sigma_\text{r}k - 2 - \omega_0^2k^2 + g\gamma_\text{r}, \nonumber \\[10pt]
    \xi_\text{r} = \frac{2S_\text{r}k^2}{M}, \quad \text{and} \quad \gamma_\text{r} = \frac{gk^2}{2M}\ .\nonumber
\end{gather}
To be able to calculate $y^{n+3/2}$, definitions for $g^{n+1/2}$ and $\Delta p^{n+1/2}$ need to be found. 

\subsubsection{Calculating $g^{n+1/2}$}
Following Chapter \ref{ch:collisions}, $g$ can be calculated using
\begin{subnumcases}{g^{n+1/2} =}
    \kappa\sqrt{\frac{K_\text{c}(\alpha_\text{c}+1)}{2}}\cdot(\eta^{n+1/2})^{\frac{\alpha_\text{c}-1}{2}},
    & if $\eta^{n+1/2} \geq 0,$ 
    \nonumber\\
    -2 \frac{\psi^{n}}{\eta^\star-\eta^{n-1/2}}, & if $\eta^{n+1/2} < 0\ \text{ and } \ \eta^{\star} \neq \eta^{n-1/2},$ \nonumber\\
    0, & $\text{if } \eta^{n+1/2} < 0\ \text{ and } \ \eta^{\star} = \eta^{n-1/2},$\nonumber
\end{subnumcases}
where parameters are as in Eq. \eqref{eq:gDef}. Furthermore, $\eta^\star = -H_0 - y^\star$ where 
\begin{equation}
    y^\star = \frac{4}{\alpha_\text{r}^\star} y^{n+1/2} + \frac{\beta_\text{r}^\star}{\alpha_\text{r}^\star}y^{n-1/2} + \frac{\xi_\text{r}}{\alpha_\text{r}^\star}\Delta p^\star,
\end{equation}
is the update equation of the system without the effect of the collision and 
\begin{gather*}
    \alpha_\text{r}^\star = 2 + \omega_0^2 k^2 + \sigma_\text{r} k, \qaq \beta_\text{r}^\star = \sigma_\text{r}k - 2 - \omega_0^2k^2,
\end{gather*}
are the coefficients in Eq. \eqref{eq:lipUpdateWithCollision} without the collision terms (as found in Eq. \eqref{eq:lipreedUpdateTerms}). Notice that $\xi_\rtxt$ is unchanged. Finally, $\Delta p^\star$ is the pressure difference calculated using Eq. \eqref{eq:pressureDiff}, i.e., without the effect of the collision. Once $g^{n+1/2}$ is calculated, $\Delta p^{n+1/2}$ can be obtained.

\subsubsection{Calculating $\Delta p^{n+1/2}$}
Following Section \ref{sec:obtainingDeltaP}, to calculate $\Delta p^{n+1/2}$, one starts by rewriting the scheme in Eq. \eqref{eq:lipReedFDSCollision} to
\begin{gather*}
    \frac{2}{k} (\delta_{t\cdot} - \delta_{t-})y^{\nph} = -\omega_0^2(k\delta_{t\cdot} + e_{t-})y^{\nph} - \sigma_\text{r}\delta_{t\cdot} y^{\nph} + \frac{S_\text{r}}{M}\Delta p^{\nph} + \left(-\frac{k}{2}g\delta_{t\cdot}y+\psi^n\right)\frac{g}{M},\\
    a_1^n\delta_{t\cdot}y^{\nph} - a_2\Delta p^{\nph} - a_3^n = 0,
\end{gather*}
with 
\begin{equation*}
    \begin{gathered}
    a_1^n = \frac{2}{k} + \omega_0^2k + \sigma_\text{r} + \frac{g^2k}{2M} \geq 0, \quad a_2 = \frac{S_\text{r}}{M} \geq 0\ , \\
     \text{and} \quad a_3^n = \left(\frac{2}{k} \delta_{t-} - \omega_0^2e_{t-}\right)y^{\nph} + \frac{g}{M}\psi^n\ .
    \end{gathered}
\end{equation*}
Note that $a_1^n$ is now time-dependent through $g$ and $\omega_0$ but remains non-negative. The rest of the variables and process in Section \ref{sec:obtainingDeltaP} are unchanged. Notice that the calculation for $\Delta p^{n+1/2}$ has to be performed twice: once to obtain the pressure difference without the collision effect $\Delta p^\star$ and once to obtain the final pressure difference $\Delta p^{n+1/2}$.

\subsubsection{Last steps}
After the definitions for $g$ and $\Delta p$ are found using the steps above, and $y^{n+3/2}$ is calculated using Eq. \eqref{eq:lipUpdateWithCollision}, $\psi^{n+1}$ can be calculated by expanding Eq. \eqref{eq:rewrittenPsi} and substituting Eq. \eqref{eq:etaNegY} according to
\begin{equation}\label{eq:psiUpdate}
    \psi^{n+1} = \psi^n - \frac{g}{2}\left(y^{n+3/2} - y^{n-1/2}\right).
\end{equation}

\subsection{Energy analysis}
The energy analysis for the lip reed shown in Section \ref{sec:energyAnalysisLipreed} can be extended to contain the collision. Equation \eqref{eq:powerBalanceLipreed} can be extended to
\begin{equation*}
    \delta_{t+}(\mathfrak{h}_\text{t}+\mathfrak{h}_\text{r}) = - \q_\text{r} - \mathfrak{p}_\text{r}+(\mu_{t+}\psi^n) \frac{\delta_{t+}\psi^n}{\delta_{t\cdot}\eta^{n+1/2}}(\delta_{t\cdot}y^{n+1/2})
\end{equation*}
which, using Eq. \eqref{eq:etaNegY} yields
\begin{equation*}
    \delta_{t+}(\mathfrak{h}_\text{t}+\mathfrak{h}_\text{r}) = - \q_\text{r} - \mathfrak{p}_\text{r}-(\mu_{t+}\psi^n) (\delta_{t+}\psi^n)
\end{equation*}
%     \xLeftrightarrow{\mystrut\ \text{Eq. \eqref{eq:etaNegY}}\ }\quad \hdots &+ (\mu_{t+}\psi^n) (\delta_{t+}\psi^n) = 0\nonumber\\
%     \hdots &+ \frac{1}{2k}(\psi^{n+1}+\psi^n)(\psi^{n+1} - \psi^n)=0\nonumber\\
%     \hdots  &+\frac{1}{2k}((\psi^{n+1})^2 - (\psi^n)^2)=0\nonumber\\
%     \hdots &+ \frac{1}{2}\delta_{t+}\left((\psi^n)^2\right) = 0\nonumber\\
%     \delta_{t+}(\mathfrak{h}_\text{t}+\mathfrak{h}_\text{r} + \mathfrak{h}_\text{c}) &+ \q_\text{r} + \mathfrak{p}_\text{r} = 0
% \end{align}
with
\begin{equation*}
    \mathfrak{h}_\text{c} = \frac{(\psi^n)^2}{2}.
\end{equation*}
% \section{Real-Time implementation}
% Branch check

% \section{Discussion}
% \SWcomment[more for your info, don't think I want to include this:]

% \subsection{Tube}
% Just to save the conversation with Stefan about Webster's equation:

% Using operators $\partial_t$ and $\partial_x$ denoting partial derivatives with respect to time $t$ and spatial coordinate $x$, respectively, a system of first-order PDEs describing the wave propagation in an acoustic tube can then be written as
% \begin{subequations}\label{eq:firstOrderSystemTrombone}
%     \begin{align}
%         \frac{S}{\rho_0 c^2}\partial_t p &= -\partial_x(Sv)\label{eq:contPressureTrombone}\\
%         \rho_0\partial_tv &= -\partial_xp\label{eq:contVelocityTrombone}
%     \end{align}
% \end{subequations}
% with acoustic pressure $p = p(x,t)$ (in N/m$^2$), particle velocity $v = v(x,t)$ (in m/s) and (circular) cross-sectional area $S(x)$ (in m$^2$). Furthermore, $\rho_0$ is the density of air (in kg/m$^3$) and $c$ is the speed of sound in air (in m/s). System \eqref{eq:firstOrderSystemTrombone} can be condensed into a second-order equation in $p$ alone, often referred to as Webster's equation \cite{Webster19}. \SWcomment[Interesting! In NSS it is the acoustic potential right? Can you go from that to a second-order PDE in $p$? There is a time-derivative hidden there somewhere right? (Just wondering :))]\SBcomment[Yes, the form in $p$ alone is the one you usually see. You get it by differentiating the first equation, giving you a $\dot{v}$ on the RHS, and then you can substitute the second equation in...I used the velocity potential one because it has direct energy balance properties. ] \SWcomment[Right. So Webster's eq. in $p$ and $\Psi$ are identical (will exhibit identical behaviour), except for the unit of the state variable..?]\SBcomment[yes that's right...using the velocity potential allows you to do all the energy analysis easily, in terms of physical impedances. But the scheme you get to in the end is the same, just one derivative down.] \SWcomment[Alright cool! Thanks for the explanation :)] For simplicity, effects of viscothermal losses have been neglected in \eqref{eq:firstOrderSystemTrombone}. For a full time domain model of such effects in an acoustic tube, see, e.g. \cite{Bilbao2016}. 
